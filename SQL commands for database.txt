-- to make table tblplchn: 

CREATE TABLE IF NOT EXISTS tblplchn (
   plid serial NOT NULL,
   chid int NOT NULL,
   PRIMARY KEY (user_id, role_id),
   FOREIGN KEY (plid)
      REFERENCES tblpricelist (plid),
   FOREIGN KEY (chidid)
      REFERENCES tblchannels (chid)
);

-- rename usrid to clid in tblpricelist:
 ALTER TABLE tblpricelist RENAME COLUMN usrid TO clid


-- to make new tabels to resolve problems with normalizations between tblchannels and tblsectable

CREATE TABLE tblsectablechn AS 
  SELECT sctid, unnest(string_to_array(rtrim(ltrim(replace (channel, '][', ','), '['), ']'), ','))::int AS chid
  FROM tblsectable;

ALTER TABLE tblsectablechn ADD CONSTRAINT pk_assign PRIMARY KEY (sctid, chid);
ALTER TABLE tblsectablechn ADD CONSTRAINT fk_sctid FOREIGN KEY (sctid) REFERENCES tblsectable (sctid);
ALTER TABLE tblsectablechn ADD CONSTRAINT fk_chid FOREIGN KEY (chid) REFERENCES tblchannels (chid);


-- to make new tabels to resolve problems with normalizations between tblchannels and tblseasonality

CREATE TABLE tblseasonalitychn AS 
  SELECT seasid, unnest(string_to_array(rtrim(ltrim(replace (channel, '][', ','), '['), ']'), ','))::int AS chid
  FROM tblseasonality;

ALTER TABLE tblseasonalitychn ADD CONSTRAINT pk_seaschid PRIMARY KEY (seasid, chid);
ALTER TABLE tblseasonalitychn ADD CONSTRAINT fk_seasseasid FOREIGN KEY (seasid) REFERENCES tblseasonality (seasid);
ALTER TABLE tblseasonalitychn ADD CONSTRAINT fk_seaschid FOREIGN KEY (chid) REFERENCES tblchannels (chid);




-- to make new tabels to resolve problems with normalizations between tblchannels and tblpricelist

CREATE TABLE tblpricelistchn AS 
  SELECT plid, unnest(string_to_array(rtrim(ltrim(replace (a2chn, '][', ','), '['), ']'), ','))::int AS chid
  FROM tblpricelist;

ALTER TABLE tblpricelistchn ADD CONSTRAINT pk_plchid PRIMARY KEY (plid, chid);
ALTER TABLE tblpricelistchn ADD CONSTRAINT fk_plplid FOREIGN KEY (plid) REFERENCES tblpricelist (plid);
ALTER TABLE tblpricelistchn ADD CONSTRAINT fk_plchid FOREIGN KEY (chid) REFERENCES tblchannels (chid);




-- to rename table tblseasonality_s to seasonalities
ALTER TABLE tblseasonality_s RENAME TO tblseasonalities;



-- to delete unnecessary columns with channel strings
ALTER TABLE tblpricelist DROP COLUMN a2chn;
ALTER TABLE tblsectable DROP COLUMN channel;
ALTER TABLE tblseasonality DROP COLUMN channel;




-- check for duplicates in tblsectables

SELECT sctid, sec, coef, 
    COUNT(*) AS CNT
FROM tblsectables
GROUP BY sctid, sec, coef
HAVING COUNT(*) > 1;



-- to delete duplicates from tblsectables
with cte1 as (
    delete
    from tblsectables
    returning *
), cte2 as (
    select
        row_number() over(partition by sctid, sec, coef order by sctid desc) as rn,
        *
    from cte1
)
insert into tblsectables
select sctid, sec, coef
from cte2
where rn = 1

-- to set primary key in tblacitivity (before this, delete contraint from pgadmin)
ALTER TABLE tblactivity ADD PRIMARY KEY (actid);

-- to add index in tblpricelistchn to speed up performances
CREATE INDEX index_tblpricelistchn ON tblpricelistchn ( plid DESC NULLS LAST  ); 

-- Changes in tblcmpspots2
ALTER TABLE tblcmpspot2 RENAME COLUMN lenght TO spotlength;
ALTER TABLE tblcmpspot2 RENAME COLUMN spotn TO spotname;

-- Changes in tblcmpgoals
ALTER TABLE tblcmpgoals RENAME COLUMN gbudget TO budget;
ALTER TABLE tblcmpgoals RENAME COLUMN ggrp TO grp;
ALTER TABLE tblcmpgoals RENAME COLUMN gins TO ins;
ALTER TABLE tblcmpgoals RENAME COLUMN grch_f1 TO rch_f1;
ALTER TABLE tblcmpgoals RENAME COLUMN grch_f2 TO rch_f2;
ALTER TABLE tblcmpgoals RENAME COLUMN grch TO rch;

-- Changes in tblcmpchn
ALTER TABLE tblcmpchn RENAME TO tblcmpchn0
CREATE TABLE IF NOT EXISTS tblcmpchn (
   cmpid int NOT NULL,
   chid int NOT NULL,
   plid int NOT NULL,
   actid int NOT NULL,
   plidbuy int,
   actidbuy int
);

-- rename column in tblchgrchn
ALTER TABLE tblchgrchn RENAME COLUMN chrdsid TO chid;

-- make table xmp
CREATE TABLE IF NOT EXISTS xmp (
   xmpid serial NOT NULL,
   schid int NOT NULL,
   cmpid int NOT NULL,
   chid int NOT NULL,
   naziv char(40),
   verzija int,
   pozicija char(3),
   vremeod char(5),
   vremedo char(5),
   vremerbl char(5),
   dani char(7),
   tipologija char(3),
   specijal bool,
   datumod date,
   datumdo date,
   progkoef numeric(5,2),
   datumkreiranja date,
   datumizmene date,
   amr1 numeric(10,2),
   amr1trim int,
   amr2 numeric(10,2),
   amr2trim int,
   amr3 numeric(10,2),
   amr3trim int,
   amrsale numeric(10,2),
   amrsaletrim int,
   amrp1 numeric(12,8),
   amrp2 numeric(12,8),
   amrp3 numeric(12,8),
   amrpsale numeric(12,8),
   dpkoef numeric(10,8),
   seaskoef numeric(10,8),
   price numeric(10,8),
   active bool,
   PRIMARY KEY (xmpid),
   FOREIGN KEY (schid)
      REFERENCES progschema (id),
   FOREIGN KEY (cmpid)
      REFERENCES tblcampaigns (cmpid),
   FOREIGN KEY (chid)
      REFERENCES tblchannels (chid)
);

-- make table xmphist
CREATE TABLE IF NOT EXISTS xmphist (
   xmphistid serial NOT NULL,
   xmpid int NOT NULL,
   schid int NOT NULL,
   chid int NOT NULL,
   naziv char(40),
   pozicija char(3),
   vremeod char(5),
   vremedo char(5),
   datum date,
   progkoef numeric(5,2),
   amr1 numeric(10,2),
   amr2 numeric(10,2),
   amr3 numeric(10,2),
   amrsale numeric(10,2),
   amrp1 numeric(12,8),
   amrp2 numeric(12,8),
   amrp3 numeric(12,8),
   amrpsale numeric(12,8),
   active bool,
   outlier bool,
   PRIMARY KEY (xmphistid),
   FOREIGN KEY (xmpid)
      REFERENCES xmp (xmpid),
   FOREIGN KEY (schid)
      REFERENCES progschema (id),
   FOREIGN KEY (chid)
      REFERENCES tblchannels (chid)
);

-- make xmpterm
CREATE TABLE IF NOT EXISTS xmpterm (
   xmptermid serial NOT NULL,
   xmpid int NOT NULL,
   datum date,
   spotcode char(1),
   PRIMARY KEY (xmptermid),
   FOREIGN KEY (xmpid)
      REFERENCES xmp (xmpid)
);

-- delete tblcmpspot and rename tblcmpspot2 to tblcmpspot



 
